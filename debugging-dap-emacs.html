<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Debugging OCaml with Emacs - OCaml Debugging and Performance</title>
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="favicon.svg">
                        <link rel="shortcut icon" href="favicon.png">
                <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
                <link rel="stylesheet" href="css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="preface.html">Preface</a></li><li class="chapter-item expanded "><a href="native-debugging.html"><strong aria-hidden="true">1.</strong> Debugging support in the OCaml compiler</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="sample-debugging-session-gdb.html"><strong aria-hidden="true">1.1.</strong> GDB on Linux debugging session</a></li><li class="chapter-item expanded "><a href="sample-debugging-session-lldb.html"><strong aria-hidden="true">1.2.</strong> LLDB on MacOS debugging session</a></li><li class="chapter-item expanded "><a href="bytecode-debugging.html"><strong aria-hidden="true">1.3.</strong> Debugging bytecode</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="debugging-dap-emacs.html" class="active"><strong aria-hidden="true">1.3.1.</strong> Debugging OCaml with Emacs</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="profiling.html"><strong aria-hidden="true">2.</strong> Profiling</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="profiling-perf.html"><strong aria-hidden="true">2.1.</strong> Using perf</a></li><li class="chapter-item expanded "><a href="flamegraphs-linux.html"><strong aria-hidden="true">2.2.</strong> Generating CPU Flamegraphs for OCaml on Linux</a></li><li class="chapter-item expanded "><a href="flamegraphs-macos.html"><strong aria-hidden="true">2.3.</strong> Generating CPU Flamegraphs for OCaml on MacOS</a></li><li class="chapter-item expanded "><a href="statmemprof-4-lts.html"><strong aria-hidden="true">2.4.</strong> Memory profiling with statmemprof in 4.14 LTS</a></li><li class="chapter-item expanded "><a href="statmemprof-5.html"><strong aria-hidden="true">2.5.</strong> Memory profiling with statmemprof in 5.3</a></li></ol></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">OCaml Debugging and Performance</h1>

                    <div class="right-buttons">
                                                <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        <a href="https://github.com/tmcgilchrist/ocaml-debug-performance" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                                                                        <a href="https://github.com/tmcgilchrist/ocaml-debug-performance/edit/main/book/debugging-dap-emacs.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>
                        
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="debugging-ocaml-with-emacs"><a class="header" href="#debugging-ocaml-with-emacs">Debugging OCaml with Emacs</a></h1>
<p>This post started as a March Hacking Days effort at Tarides. I have been working on improving the debugging situation for OCaml and wanted to see how easily I could setup debug support in Emacs using DAP. Debug Adapter Protocol (DAP) is a wire protocol for communicating between an editor/IDE and a debug server like LLDB, providing an abstraction over debugging, similar to how Language Server Protocol (LSP) provides language support.</p>
<p>OCaml comes with support for debugging native programs with GDB and LLDB, and bytecode code programs using ocamldebug and earlybird. In this post we will cover setting up and debugging both kinds of programs. I am using an M3 Mac so all examples will show ARM64 assembly and macOS specific paths. The same setup should work on Linux. I use <a href="https://github.com/bbatsov/prelude">prelude</a> to configure my Emacs with my own customistations in <code>.emacs/personal</code>, adjust for your own personal Emacs setup.</p>
<p>Let's start with the following program:</p>
<pre><code class="language-ocaml">(* fib.ml *)
let rec fib n =
  if n = 0 then 0
  else if n = 1 then 1
  else fib (n-1) + fib (n-2)

let main () =
  let r = fib 20 in
  Printf.printf &quot;fib(20) = %d&quot; r

let _ = main ()
</code></pre>
<p>And this dune configuration in the same directory.</p>
<pre><code class="language-ocaml">; dune
(executable
 (name fib)
 (modules fib)
 (modes exe byte))
</code></pre>
<pre><code class="language-ocaml">; dune-project
(lang dune 3.11)
(map_workspace_root false)
</code></pre>
<p>Create an empty opam switch in same directory and install dune:</p>
<pre><code class="language-shell">$ opam switch create . 5.1.1 --no-install
$ opam install dune
</code></pre>
<h2 id="emacs-configuration"><a class="header" href="#emacs-configuration">Emacs configuration</a></h2>
<p>Emacs has <a href="https://github.com/emacs-lsp/dap-mode">dap-mode</a> that provides everything we need. Install it using <code>M-x package-install</code> and choose the <code>dap-mode</code> package. I have the following lines in my <code>.emacs/personal/init.el</code>:</p>
<pre><code class="language-emacs-lisp">; Require dap-mode plus the two extra files we need
(require 'dap-mode)
(require 'dap-codelldb)
(require 'dap-ocaml)

; Setup key bindings using use-package.
(use-package dap-mode
  :bind ((&quot;C-c M-n&quot; . dap-next)
         (&quot;C-c M-s&quot; . dap-step-in)
         (&quot;C-c M-a&quot; . dap-step-out)
         (&quot;C-c M-w&quot; . dap-continue)))
</code></pre>
<p>Save and restart Emacs, then we can move onto setting up Bytecode debugging.</p>
<h2 id="bytecode-debugging"><a class="header" href="#bytecode-debugging">Bytecode debugging</a></h2>
<p>The <a href="https://github.com/hackwaly/ocamlearlybird">earlybird</a> project provides DAP support for debugging OCaml bytecode.
Earlybird uses the (undocumented) protocol of ocamldebug to communicate with a bytecode executable, inheriting the
same functionality as ocamldebug. Start by installing the package:</p>
<pre><code class="language-shell">opam install earlybird
</code></pre>
<p>then create a file in <code>.vscode/launch.json</code> with this configuration:</p>
<pre><code class="language-json">{
    &quot;version&quot;: &quot;0.2.0&quot;,
    &quot;configurations&quot;: [
        {
            &quot;name&quot;: &quot;OCaml earlybird (experimental)&quot;,
            &quot;type&quot;: &quot;ocaml.earlybird&quot;,
            &quot;request&quot;: &quot;launch&quot;,
            &quot;program&quot;: &quot;./_build/default/fib.bc&quot;,
            &quot;stopOnEntry&quot;: true,
            &quot;cwd&quot;: &quot;${workspaceFolder}&quot;
        },
}
</code></pre>
<p>Build the project with <code>dune build</code> to create the <code>fib.bc</code> bytecode file. Finally start a debugger with <code>M-x dap-debug</code>. It will prompt you to choose a session, we want <code>OCaml earlybird (experimental)</code> from the named configuration above. It will start earlybird and immediately stop it before executing any OCaml code.</p>
<p>To set breakpoints you need to open the OCaml source file in <code>_build/default/fib.ml</code> and click on the source lines you want to stop at. Here is what it looks like after a few recursions. Use the buttons to control the debugger or use the keybindings we added. Curiously they are not pre-defined but here I've tried to reuse mappings from <a href="https://v2.ocaml.org/manual/debugger.html#s:inf-debugger">ocamldebug</a>.</p>
<h2 id="native-debugging"><a class="header" href="#native-debugging">Native debugging</a></h2>
<p>OCaml can also produce native binaries that can be debugged using GDB or LLDB, depending on your platform. Here we will use LLDB on macOS.</p>
<p>Add another section to <code>.vscode/launch.json</code> for starting lldb.</p>
<pre><code class="language-json">        {
            &quot;type&quot;: &quot;lldb&quot;,
            &quot;request&quot;: &quot;launch&quot;,
            &quot;name&quot;: &quot;LLDB with ocamlopt&quot;,
            &quot;program&quot;: &quot;./fib.exe&quot;,
            &quot;args&quot;: [],
            &quot;stopOnEntry&quot;: true,
            &quot;cwd&quot;: &quot;${workspaceFolder}&quot;
        },
</code></pre>
<p>Run <code>M-x dap-codelldb-setup</code> which will download the codelldb DAP program that we are using to communicate with LLDB. This gets installed into <code>.extension/vscode/codelldb</code>.</p>
<p>Now compile the fib program with <code>ocamlopt -g -o fib.exe fib.ml</code> and startup a debugger session with <code>M-x dap-debug</code> choose the <code>LLDB with ocamlopt</code> option. You should see something similar to:</p>
<p>Now DAP as setup with LLDB and macOS, is a little broken and is missing support for setting breakpoints on symbols. Lets add that :-)</p>
<p>The second option is debugging with Dune, this is slightly different for two reasons. First Dune places the executable into <code>_build/default/fib.exe</code> and second Dune produces slightly different sym bols. We need a new section in <code>.vscode/launch.json</code> for Dune</p>
<pre><code class="language-json">        {
            &quot;type&quot;: &quot;lldb&quot;,
            &quot;request&quot;: &quot;launch&quot;,
            &quot;name&quot;: &quot;LLDB with Dune&quot;,
            &quot;program&quot;: &quot;./_build/default/fib.exe&quot;,
            &quot;args&quot;: [],
            &quot;stopOnEntry&quot;: true,
            &quot;cwd&quot;: &quot;${workspaceFolder}&quot;
        },
</code></pre>
<p>Remove the old <code>fib.exe</code> in the project directory and run <code>dune build</code>. Startup a new DAP session with <code>M-x dap-debug</code> and choose <code>LLDB with Dune</code>. You should see the same debugger session as before.</p>
<h2 id="conclusion"><a class="header" href="#conclusion">Conclusion</a></h2>
<p>Debugging OCaml with DAP inside Emacs is possible. Use <code>dap-mode</code> with:</p>
<pre><code class="language-emacs-lisp">(require 'dap-mode)
(require 'dap-codelldb)
(require 'dap-ocaml)

(use-package dap-mode
  :bind ((&quot;C-c M-n&quot; . dap-next)
         (&quot;C-c M-s&quot; . dap-step-in)
         (&quot;C-c M-a&quot; . dap-step-out)
         (&quot;C-c M-w&quot; . dap-continue)))

</code></pre>
<p>and a <code>launch.json</code> of</p>
<pre><code class="language-json">{
    &quot;version&quot;: &quot;0.2.0&quot;,
    &quot;configurations&quot;: [
        {
            &quot;name&quot;: &quot;OCaml earlybird (experimental)&quot;,
            &quot;type&quot;: &quot;ocaml.earlybird&quot;,
            &quot;request&quot;: &quot;launch&quot;,
            &quot;program&quot;: &quot;./_build/default/fib.bc&quot;,
            &quot;stopOnEntry&quot;: true,
            &quot;cwd&quot;: &quot;${workspaceFolder}&quot;
        },
        {
            &quot;type&quot;: &quot;lldb&quot;,
            &quot;request&quot;: &quot;launch&quot;,
            &quot;name&quot;: &quot;LLDB with Dune&quot;,
            &quot;program&quot;: &quot;./_build/default/fib.exe&quot;,
            &quot;args&quot;: [],
            &quot;stopOnEntry&quot;: true,
            &quot;cwd&quot;: &quot;${workspaceFolder}&quot;
        },
        {
            &quot;type&quot;: &quot;lldb&quot;,
            &quot;request&quot;: &quot;launch&quot;,
            &quot;name&quot;: &quot;LLDB with ocamlopt&quot;,
            &quot;program&quot;: &quot;./fib.exe&quot;,
            &quot;args&quot;: [],
            &quot;stopOnEntry&quot;: true,
            &quot;cwd&quot;: &quot;${workspaceFolder}&quot;
        }
    ]
}
</code></pre>
<p>The same setup will work under VSCode with the <code>CodeLLDB</code> and <code>OCaml Platform</code> extensions installed. Happy Emacs debugging.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                                                    <a rel="prev" href="bytecode-debugging.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                                                    <a rel="next" href="profiling.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                                    <a rel="prev" href="bytecode-debugging.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                                    <a rel="next" href="profiling.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
                <script type="text/javascript" src="mermaid.min.js"></script>
                <script type="text/javascript" src="mermaid-init.js"></script>
        
        
    </body>
</html>
