<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Generating CPU Flamegraphs for OCaml on MacOS - OCaml Debugging and Performance</title>
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="favicon.svg">
                        <link rel="shortcut icon" href="favicon.png">
                <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
                <link rel="stylesheet" href="css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="preface.html">Preface</a></li><li class="chapter-item expanded "><a href="native-debugging.html"><strong aria-hidden="true">1.</strong> Debugging support in the OCaml compiler</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="sample-debugging-session-gdb.html"><strong aria-hidden="true">1.1.</strong> GDB on Linux debugging session</a></li><li class="chapter-item expanded "><a href="sample-debugging-session-lldb.html"><strong aria-hidden="true">1.2.</strong> LLDB on MacOS debugging session</a></li><li class="chapter-item expanded "><a href="bytecode-debugging.html"><strong aria-hidden="true">1.3.</strong> Debugging bytecode</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="debugging-dap-emacs.html"><strong aria-hidden="true">1.3.1.</strong> Debugging OCaml with Emacs</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="profiling.html"><strong aria-hidden="true">2.</strong> Profiling</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="profiling-perf.html"><strong aria-hidden="true">2.1.</strong> Using perf</a></li><li class="chapter-item expanded "><a href="flamegraphs-linux.html"><strong aria-hidden="true">2.2.</strong> Generating CPU Flamegraphs for OCaml on Linux</a></li><li class="chapter-item expanded "><a href="flamegraphs-macos.html" class="active"><strong aria-hidden="true">2.3.</strong> Generating CPU Flamegraphs for OCaml on MacOS</a></li><li class="chapter-item expanded "><a href="statmemprof-4-lts.html"><strong aria-hidden="true">2.4.</strong> Memory profiling with statmemprof in 4.14 LTS</a></li><li class="chapter-item expanded "><a href="statmemprof-5.html"><strong aria-hidden="true">2.5.</strong> Memory profiling with statmemprof in 5.3</a></li></ol></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">OCaml Debugging and Performance</h1>

                    <div class="right-buttons">
                                                <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        <a href="https://github.com/tmcgilchrist/ocaml-debug-performance" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                                                                        <a href="https://github.com/tmcgilchrist/ocaml-debug-performance/edit/main/book/flamegraphs-macos.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>
                        
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="generating-ocaml-flamegraphs-on-macos"><a class="header" href="#generating-ocaml-flamegraphs-on-macos">Generating OCaml flamegraphs on MacOS</a></h1>
<p>Flame Graphs are a visualisation for sampled stack frames. They provide a great way to visualise stack traces of profiled software to identify the most frequent code-paths and optimise them. Popularised by Brendan Gregg <em>loads</em> more information can be found on his blog https://www.brendangregg.com/flamegraphs.html</p>
<p>Here we are interested in how we can generate Flame Graphs for OCaml programs on macOS.
macOS is what I use for development work and I could not find other documentation on how to do this.
So here we are.</p>
<h2 id="getting-started"><a class="header" href="#getting-started">Getting Started</a></h2>
<p>First we need <strong>XCode</strong> and Instruments installed, get them via the App Store by searching for XCode and installing that. <strong>Instruments.app</strong> is Apple's profiling tool for capturing and visualising traces, along with many other interesting things. It is built on top of the DTrace tracing framework from OpenSolaris, which was ported to Mac OS X v10.5 and is available in all following versions of macOS. Dtrace is very cool and deserves its own post on how to use it effectively on OCaml programs.</p>
<p>After XCode is installed confirm that Instruments is also installed, this command will find the <code>xctrace</code> executable:</p>
<pre><code class="language-shell">$ xcrun --find xctrace
/Applications/Xcode.app/Contents/Developer/usr/bin/xctrace
</code></pre>
<p><code>xctrace</code> is a command line version of Instruments which allows capturing traces from a terminal. To run a Time Profiler against an OCaml process use the following command, substituing <em>PROGRAM</em> with the OCaml executable. Often found under <code>_build/default</code> directory of a Dune project. For my project the executable is called<code>./_build/default/stress/stress.exe</code></p>
<pre><code class="language-shell">$ xctrace record --output . --template &quot;Time Profiler&quot; \
                 --target-stdout - --launch -- PROGRAM
</code></pre>
<p>This will create a trace file ending in <code>.trace</code>, open that trace file in Instruments, select the <code>Time Profiler</code> and select a Stack Thread in the lower left pane. Choose Select Edit &gt; Deep Copy from the menu and paste the output into a file called <code>ocaml-program.trace</code>. On MacOS Sonoma using Instruments 15.2 it looks like:</p>
<p><img src="macos-instruments-screen.png" alt="instruments-screenshot" /></p>
<p>Next download the Perl file https://github.com/brendangregg/FlameGraph/blob/master/stackcollapse-instruments.pl
to reduce the trace into a format that Flame Graphs can understand. You will need to make it executable with <code>chmod +x stackcollapse-instruments.pl</code></p>
<pre><code class="language-shell">./stackcollapse-instruments.pl ocaml-program.trace &gt; ocaml-program.outfile
</code></pre>
<p>Then download the Flame Graph tool https://github.com/brendangregg/FlameGraph/blob/master/flamegraph.pl and
run that against the outfile created by stackcollapse-instruments. Again make it executable with <code>chmod +x</code></p>
<pre><code class="language-shell">./flamegraph.pl ocaml-program.outfile &gt; ocaml-program.svg
</code></pre>
<p>This will produce an application level Flame Graph of the traced application stored in <code>ocaml-program.svg</code>.
Open that up in a Browser and click around to see where your OCaml program is spending it's time.</p>
<p>Another visualisation option is https://www.speedscope.app which can take the <code>.trace</code> file and produce a Flame Graph, without needing to run any scripts locally.</p>
<h2 id="in-practice-flame-graph-for-solver-service"><a class="header" href="#in-practice-flame-graph-for-solver-service">In Practice: Flame Graph for solver-service</a></h2>
<p>Recently I have been looking at the performance of the <a href="http://github.com/ocurrent/solver-service">solver-service</a> which is used to perform opam solves for the OCaml Continuous Integration services run by Tarides. The code uses OCaml 5 with EIO and is expected to scale across multiple CPUs.</p>
<p>I used this xctrace command to run the stress test, setting some Garbage Collection parameters:</p>
<pre><code class="language-shell">$ xctrace record --template &quot;Time Profiler&quot; \
                 --env=OCAMLRUNPARAM=&quot;M=352&quot; --target-stdout \
                 - --launch -- ./_build/default/stress/stress.exe local \
                 --cache-dir=./cache --count=10
...
Solved warm-up requests in: 12.37s
Running another 10 solves...
10/10 complete
Solved 10 requests in 10.06s (1.01s/iter) (15.91 solves/s)
Target app exited, ending recording...
Recording completed. Saving output file...
Output file saved as: Launch_stress.exe_2024-01-18_11.45.55_042428AC.trace
$ open Launch_stress.exe_2024-01-18_11.45.55_042428AC.trace
# Export data into a file called `macos-solver-02.trace`
$ ./stackcollapse-instruments.pl macos-solver-02.trace &gt; macos-solver-02.outfile
$ ./flamegraph.pl macos-solver-02.outfile &gt; macos-solver-02.svg
</code></pre>
<p>Producing this Flame Graph for the service. Note this was running on a 12 core M3Pro MacBookPro hence the 12 peaks relating to OCaml 5 using all available cores in this machine.
<img src="macos-flamegraph.svg" alt="macos-solver-02" /></p>
<p>Next step is working out where time is being spend and where we can speed up things.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                                                    <a rel="prev" href="flamegraphs-linux.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                                                    <a rel="next" href="statmemprof-4-lts.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                                    <a rel="prev" href="flamegraphs-linux.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                                    <a rel="next" href="statmemprof-4-lts.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
                <script type="text/javascript" src="mermaid.min.js"></script>
                <script type="text/javascript" src="mermaid-init.js"></script>
        
        
    </body>
</html>
