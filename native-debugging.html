<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Debugging support in the OCaml compiler - OCaml Debugging and Performance</title>
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="favicon.svg">
                        <link rel="shortcut icon" href="favicon.png">
                <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
                <link rel="stylesheet" href="css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="preface.html">Preface</a></li><li class="chapter-item expanded "><a href="native-debugging.html" class="active"><strong aria-hidden="true">1.</strong> Debugging support in the OCaml compiler</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="sample-debugging-session-gdb.html"><strong aria-hidden="true">1.1.</strong> GDB on Linux debugging session</a></li><li class="chapter-item expanded "><a href="sample-debugging-session-lldb.html"><strong aria-hidden="true">1.2.</strong> LLDB on MacOS debugging session</a></li><li class="chapter-item expanded "><a href="bytecode-debugging.html"><strong aria-hidden="true">1.3.</strong> Debugging bytecode</a></li></ol></li><li class="chapter-item expanded "><a href="profiling.html"><strong aria-hidden="true">2.</strong> Profiling</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="profiling-perf.html"><strong aria-hidden="true">2.1.</strong> Using perf</a></li><li class="chapter-item expanded "><a href="flamegraphs-linux.html"><strong aria-hidden="true">2.2.</strong> Generating CPU Flamegraphs for OCaml on Linux</a></li><li class="chapter-item expanded "><a href="flamegraphs-macos.html"><strong aria-hidden="true">2.3.</strong> Generating CPU Flamegraphs for OCaml on MacOS</a></li><li class="chapter-item expanded "><a href="statmemprof-4-lts.html"><strong aria-hidden="true">2.4.</strong> Memory profiling with statmemprof in 4.14 LTS</a></li><li class="chapter-item expanded "><a href="statmemprof-5.html"><strong aria-hidden="true">2.5.</strong> Memory profiling with statmemprof in 5.3</a></li></ol></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">OCaml Debugging and Performance</h1>

                    <div class="right-buttons">
                                                <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        <a href="https://github.com/tmcgilchrist/ocaml-debug-performance" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                                                                        <a href="https://github.com/tmcgilchrist/ocaml-debug-performance/edit/main/book/native-debugging.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>
                        
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="debugging-support-in-the-ocaml-compiler"><a class="header" href="#debugging-support-in-the-ocaml-compiler">Debugging support in the OCaml compiler</a></h1>
<!-- toc -->
<p>This document explains the state of debugging tools support in the OCaml compiler.
It gives an overview of GDB, LLDB, WinDbg/CDB, as well as infrastructure around OCaml
compiler to debug OCaml code.</p>
<p>The material contains both current support and ideas for future areas to improve.</p>
<h2 id="preliminaries"><a class="header" href="#preliminaries">Preliminaries</a></h2>
<h3 id="debuggers"><a class="header" href="#debuggers">Debuggers</a></h3>
<p>According to wikipedia <a href="https://en.wikipedia.org/wiki/Debugger">1</a></p>
<blockquote>
<p>A debugger or debugging tool is a computer program used to test and debug other programs (the &quot;target&quot; program).</p>
</blockquote>
<p>Writing a debugger from scratch for a language requries considerable work, especially if you want to support
various platforms like Linux, MacOS, and Windows. Existing debuggers like GDB and LLDB can be extended to support
debugging a language like OCaml. This is the path OCaml has chosen for what I'll call native debugging, debugging
exectuables compiled to object code via assembly and run on a CPU. OCaml also includes a debugger for the bytecode
exectuables it also produces, more on that later.</p>
<h3 id="dwarf"><a class="header" href="#dwarf">DWARF</a></h3>
<p>According to the <a href="http://dwarfstd.org">DWARF</a> standard website:</p>
<blockquote>
<p>DWARF is a debugging information file format used by many compilers and debuggers to support source level
debugging. It addresses the requirements of a number of procedural languages, such as C, C++, and Fortran,
and is designed to be extensible to other languages. DWARF is architecture independent and applicable to
any processor or operating system. It is widely used on Unix, Linux and other operating systems, as well
as in stand-alone environments.</p>
</blockquote>
<p>DWARF allows a compiler to describe how program source translates to assembly, using a data structure called
Debugging Information Entry (DIE) which stores the information as &quot;tags&quot; to denote functions, variables etc.,
e.g., <code>DW_TAG_variable</code>, <code>DW_TAG_pointer_type</code>, <code>DW_TAG_subprogram</code> etc.
You can also invent your own tags and attributes.</p>
<p>DWARF reader is a program that consumes the DWARF format and creates debugger compatible output.
This program may live in the compiler itself.</p>
<h3 id="codeviewpdb"><a class="header" href="#codeviewpdb">CodeView/PDB</a></h3>
<p><a href="https://llvm.org/docs/PDB/index.html">PDB</a> (Program Database) is a file format created by Microsoft that contains debug information.
PDBs can be consumed by debuggers such as WinDbg/CDB and other tools to display debug information.
A PDB contains multiple streams that describe debug information about a specific binary such
as types, symbols, and source files used to compile the given binary. CodeView is another
format which defines the structure of <a href="https://llvm.org/docs/PDB/CodeViewSymbols.html">symbol records</a> and <a href="https://llvm.org/docs/PDB/CodeViewTypes.html">type records</a> that appear within
PDB streams.</p>
<h3 id="compact-unwinding-format"><a class="header" href="#compact-unwinding-format">Compact Unwinding Format</a></h3>
<p>Apple introduced a new kind of unwinding info the “compact unwinding format” on Apple platforms like macOS and iOS.
The Clang compiler on those platforms emits this format along with DWARF CFI. The format is described by the implementation
in clang/llvm, with an independent description provided at <a href="https://faultlore.com/blah/compact-unwinding/">https://faultlore.com/blah/compact-unwinding/</a> and <a href="https://github.com/mstange/macho-unwind-info">https://github.com/mstange/macho-unwind-info</a> So to generate good backtraces on Apple platforms, you need to be able to parse and interpret compact unwinding tables. Further details of how Apple uses <a href="https://opensource.apple.com/source/gdb/gdb-250/doc/stabs.pdf">STABS</a> plus DWARF for debug info <a href="https://wiki.dwarfstd.org/Apple%27s_%22Lazy%22_DWARF_Scheme.md">https://wiki.dwarfstd.org/Apple%27s_%22Lazy%22_DWARF_Scheme.md</a>.</p>
<h2 id="supported-debuggers"><a class="header" href="#supported-debuggers">Supported debuggers</a></h2>
<h3 id="gdb"><a class="header" href="#gdb">GDB</a></h3>
<p>OCaml supports GBD on Linux for all OCaml supported platforms, it supports basic debugging like setting breakpoints, stepping,
backtraces etc. A sample GDB/Linux session is <a href="sample-debugging-session.html">shown here</a>.
Additionally there are GDB macros <a href="https://github.com/ocaml/ocaml/blob/trunk/tools/gdb-macros">gdb-macros</a> and Python macros <a href="https://github.com/ocaml/ocaml/blob/trunk/tools/gdb_ocamlrun.py">gdb_ocamlrun.py</a> that provide low-level debugging of OCaml programs and of the
OCaml runtime itself (both native and byte-code).</p>
<h4 id="ocaml-parser-extensions"><a class="header" href="#ocaml-parser-extensions">OCaml parser extensions</a></h4>
<p>To be able to show debug output, we need an expression parser. GDB expression parsers are written in [Bison],
and could be written to accept a subset of OCaml expressions, including printing OCaml values knowing the
boxed types used by OCaml. Read the <a href="https://dev.realworldocaml.org/runtime-memory-layout.html">Memory Representation of Values</a> chapter of RealWorld OCaml for more details.</p>
<p>Future work:</p>
<ul>
<li>Restore DWARF CFI for POWER native code</li>
<li>Port more GDB macros to Python</li>
<li>Add a source language to GDB https://sourceware.org/gdb/wiki/Internals%20Adding-a-Source-Language-to-GDB</li>
</ul>
<h3 id="lldb"><a class="header" href="#lldb">LLDB</a></h3>
<p>LLDB is the default debugger on MacOS, shipped with XCode and generally works the best on that platform.
It is also available on Linux and is the <a href="https://docs.freebsd.org/en/books/developers-handbook/tools/#debugging">default debugger for FreeBSD</a>.</p>
<ul>
<li>LLDB has a plugin architecture but that does not work for language support.</li>
<li>At present GDB generally works better on Linux.</li>
</ul>
<h4 id="ocaml-parser-extensions-1"><a class="header" href="#ocaml-parser-extensions-1">OCaml parser extensions</a></h4>
<p>This expression parser is written in C++. It is a type of Recursive Descent parser.</p>
<p>Some initial work on OCaml LLDB support at https://github.com/ocaml-flambda/llvm-project</p>
<p><strong>What is included here?</strong></p>
<h3 id="rr"><a class="header" href="#rr">RR</a></h3>
<p>rr is a lightweight tool for recording, replaying and debugging execution of applications (trees of
processes and threads). Debugging extends gdb with very efficient reverse-execution, which in
combination with standard gdb/x86 features like hardware data watchpoints, makes debugging much more
fun. OCaml supports RR on Linux for certain x86_64 and ARM64 platforms.</p>
<p>Future work:</p>
<ul>
<li>Validate RR on macOS/LLDB platform</li>
<li>Validate RR on Linux/LLDB platform</li>
<li>RR doesn't currently support Apple M3 chips see https://github.com/rr-debugger/rr/pull/3528</li>
</ul>
<h3 id="windbgcdb"><a class="header" href="#windbgcdb">WinDbg/CDB</a></h3>
<p>Microsoft provides <a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/debugger/">Windows Debugging Tools</a> such as the Windows Debugger (WinDbg) and the Console Debugger (CDB)
which both support debugging programs that provide PDB information. These debuggers parse the debug info fpor a
binary from the PDB, if available, to construct a visualization to serve up in the debugger. Currently the OCaml
compiler does not produce PDB and future work is required to support debugging on Windows. Additionally OCaml on Windows
provides three different ports, complicating the matter further.</p>
<h2 id="dwarf-and-ocaml"><a class="header" href="#dwarf-and-ocaml">DWARF and OCaml</a></h2>
<p>DWARF is a widely-used format for representing debug information for
consumption by debugging tools but also for runtime systems and profiling.
DWARF information is typically embedded within an executable and provides
a way to represent a variety of information:</p>
<ul>
<li><em>line information</em> mapping instructions back to their location in the source
program. eg assembly instruction at address <code>x</code> originated from <code>main.ml</code>
at line 13</li>
<li><em>unwind information</em> allowing call chains to be reconstructed from the
runtime state of the exectution stack. eg OCaml program is currently
running function <code>x</code>, which was called from <code>y</code> and so on. This is
particularly interesting for multicore which introduced fibers and
effects, and their runtime managed stack segments.</li>
<li><em>type information</em> allowing debugging tools to reconstruct the structure
and identity of values from the runtime state of the program.
eg when an OCaml program is executing assembly instruction at address <code>x</code>
what is the OCaml value sitting in a register.</li>
</ul>
<p>This information allows debuggers (eg gdb or lldb) and profiling tools to do what they do.</p>
<p>The OCaml compiler has included DWARF support for some time, with the
large changes comming from OCaml 5 and the associated runtime changes
the DWARF support needed to be restored and improved.</p>
<p>There are a number of potential user-cases for DWARF information:</p>
<ol>
<li>Use in native debugging tools like <code>gdb</code> and <code>lldb</code></li>
<li>Statisical profiling using tools like perf</li>
<li>Computing call stacks for ThreadSanitizer, a data race detection tool</li>
</ol>
<h3 id="ocaml-to-dwarf-die-mapping"><a class="header" href="#ocaml-to-dwarf-die-mapping">OCaml to DWARF DIE Mapping</a></h3>
<p>Provide a small example of how OCaml gets mapped to DWARF DIEs</p>
<p>DW_TAG_base_type provide base type mappings that can be defined per language.
Should OCaml be using this to output DWARF representations.</p>
<p>DW_TAG_variable describes a variable in the source language</p>
<p>https://dwarfstd.org/doc/Debugging%20using%20DWARF-2012.pdf</p>
<pre><code>$ 
COMPILE_UNIT&lt;header overall offset = 0x00000047&gt;:
&lt; 0&gt;&lt;0x0000000b&gt;  DW_TAG_compile_unit
                    DW_AT_stmt_list             0x00000062
                    DW_AT_low_pc                0x0004b6a0
                    DW_AT_high_pc               0x0004b760
                    DW_AT_name                  fib.ml
                    DW_AT_comp_dir              /home/tsmc/ocaml
                    DW_AT_producer              GNU AS 2.41
                    DW_AT_language              DW_LANG_Mips_Assembler

LOCAL_SYMBOLS:
&lt; 1&gt;&lt;0x0000002e&gt;    DW_TAG_subprogram
                      DW_AT_name                  camlFib__main_1_3_code
                      DW_AT_external              yes(1)
                      DW_AT_type                  &lt;0x00000073&gt;
                      DW_AT_low_pc                0x0004b6f8
                      DW_AT_high_pc               0x0004b73c
&lt; 1&gt;&lt;0x00000045&gt;    DW_TAG_subprogram
                      DW_AT_name                  camlFib__fib_0_2_code
                      DW_AT_external              yes(1)
                      DW_AT_type                  &lt;0x00000073&gt;
                      DW_AT_low_pc                0x0004b6a0
                      DW_AT_high_pc               0x0004b6f4
&lt; 1&gt;&lt;0x0000005c&gt;    DW_TAG_subprogram
                      DW_AT_name                  camlFib__entry
                      DW_AT_external              yes(1)
                      DW_AT_type                  &lt;0x00000073&gt;
                      DW_AT_low_pc                0x0004b740
                      DW_AT_high_pc               0x0004b760
&lt; 1&gt;&lt;0x00000073&gt;    DW_TAG_unspecified_type
</code></pre>
<h2 id="ocaml-name-mangling"><a class="header" href="#ocaml-name-mangling">OCaml Name Mangling</a></h2>
<h2 id="what-is-missing"><a class="header" href="#what-is-missing">What is missing?</a></h2>
<h2 id="resources"><a class="header" href="#resources">Resources</a></h2>
<p>Tom Tromey discusses debugging support in rustc, provides a good overview of the area and what OCaml
might also want to do - <a href="https://www.youtube.com/watch?v=elBxMRSNYr4">https://www.youtube.com/watch?v=elBxMRSNYr4</a></p>
<p><a href="https://rustc-dev-guide.rust-lang.org/debugging-support-in-rustc.html">https://rustc-dev-guide.rust-lang.org/debugging-support-in-rustc.html</a></p>
<p>DWARF support in GHC (4 part series) <a href="https://well-typed.com/blog/2020/04/dwarf-1/">https://well-typed.com/blog/2020/04/dwarf-1/</a></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                                                    <a rel="prev" href="preface.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                                                    <a rel="next" href="sample-debugging-session-gdb.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                                    <a rel="prev" href="preface.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                                    <a rel="next" href="sample-debugging-session-gdb.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
                <script type="text/javascript" src="mermaid.min.js"></script>
                <script type="text/javascript" src="mermaid-init.js"></script>
        
        
    </body>
</html>
